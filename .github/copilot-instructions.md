# Copilot Instructions — FanPulse

## Architecture

This repo contains three independent applications that implement the **Model Context Protocol (MCP)**:

- **`FanPulse/`** — MCP Server (C# / .NET 10). Exposes 7 fan-engagement tools over **stdio transport**. Returns JSON text responses. Any MCP client can connect to it.
- **`FanPulseApps/`** — MCP Server (TypeScript / Node.js). Reimplements the same 7 tools with **interactive HTML UIs** using the MCP Apps extension (`@modelcontextprotocol/ext-apps`). Supports both **stdio and HTTP/SSE** transports. Five tools include rich UIs (segment cards, product grid, engagement chart, recommendation cards, promo builder form); two return JSON.
- **`FanPulseDashboard/`** — MCP Client (C# / .NET 10). Connects to either server via a startup selection menu, adds an AI-powered conversational layer using **GitHub Models (GPT-4o)**.

Data flows: **User → Dashboard (AI chat) → MCP Server (C# or TypeScript) → SQLite (`fanpulse.db`)**

Both servers share the same `fanpulse.db` database. The C# server creates and seeds it on first run. There is no solution file; each project is built and run independently.

## Build & Run

```powershell
# Build the C# projects
dotnet build FanPulse
dotnet build FanPulseDashboard

# Build the TypeScript project
cd FanPulseApps && npm install && npm run build && cd ..

# Run the C# MCP server (stdio — typically launched by an MCP client)
dotnet run --project FanPulse

# Run the TypeScript MCP server (HTTP mode)
cd FanPulseApps && npm start

# Run the TypeScript MCP server (stdio mode)
cd FanPulseApps && npm run start:stdio

# Run the Dashboard (interactive AI chat console — prompts for server selection)
$env:GITHUB_TOKEN = "ghp_..."   # GitHub PAT with GitHub Models access
dotnet run --project FanPulseDashboard
```

There are no tests, linters, or CI pipelines configured.

## Key Conventions

### MCP Tool Definitions (C# Server)

Tools are static methods on a single class annotated with `[McpServerToolType]`:

```csharp
[McpServerToolType]
public class FanTools
{
    [McpServerTool, Description("...")]
    public static string ToolName([Description("...")] string param) { ... }
}
```

Tools are registered in `Program.cs` via `.WithTools<FanTools>()`. All tools return JSON strings via `System.Text.Json`.

### MCP Tool Definitions (TypeScript Server)

Tools with UIs use `registerAppTool` and `registerAppResource` from `@modelcontextprotocol/ext-apps/server`. Tools without UIs use `server.tool()` directly. Input schemas are defined with Zod. All tools are registered in `src/tools/fan-tools.ts` and wired up in `server.ts` via a `createServer()` factory function.

### Data Access

- **C# Server**: Raw ADO.NET with `Microsoft.Data.Sqlite` — no Entity Framework.
- **TypeScript Server**: `better-sqlite3` with prepared statements.

Both access the same `fanpulse.db`, auto-created and seeded on C# server startup by `DatabaseInitializer.Initialize()`. Schema uses five tables: `Fans`, `EngagementEvents`, `Merchandise`, `Purchases`, `Promotions`.

### ID Patterns

Entity IDs follow a consistent format: `fan-001`, `prod-001`, `evt-001`, `pur-001`, `promo-{guid}`. New IDs for events and promotions are generated by truncating a GUID.

### Dashboard ↔ Server Communication

The Dashboard launches the selected MCP server as a child process via `StdioClientTransport`. For the C# server: `dotnet run --project FanPulse`. For the TypeScript server: `node dist/main.js --stdio`. Both server projects must be built before the Dashboard can use them.

### UI Bundling (TypeScript Server)

Each UI is a standalone HTML file in `src/ui/<tool-name>/`. Vite + `vite-plugin-singlefile` bundles each into a self-contained HTML string (inline CSS/JS) in `dist/`. The server serves these as `ui://` resources with `text/html+mcp` MIME type.

## Dependencies

| Package | Used In | Purpose |
|---|---|---|
| `ModelContextProtocol` (0.8.0-preview.1) | FanPulse, Dashboard | MCP server/client SDK (C#) |
| `Microsoft.Data.Sqlite` | FanPulse | SQLite data access (C#) |
| `Microsoft.Extensions.AI` + `AI.OpenAI` | Dashboard | LLM chat via GitHub Models |
| `Microsoft.Extensions.Hosting` | FanPulse, Dashboard | Generic host for DI and lifecycle |
| `@modelcontextprotocol/sdk` | FanPulseApps | MCP server SDK (TypeScript) |
| `@modelcontextprotocol/ext-apps` | FanPulseApps | MCP Apps extension (interactive UIs) |
| `better-sqlite3` | FanPulseApps | SQLite data access (TypeScript) |
| `chart.js` | FanPulseApps | Engagement metrics chart rendering |
| `vite` + `vite-plugin-singlefile` | FanPulseApps | Bundle UIs into single HTML files |
